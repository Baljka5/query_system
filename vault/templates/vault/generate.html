{% load static %}
<!doctype html>
<html lang="mn">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Generate SQL — QueryVault</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CodeMirror -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.css">
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/lib/codemirror.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/mode/sql/sql.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@5.65.16/theme/eclipse.css">
    <style>.CodeMirror {
        height: 320px;
        border-radius: 0.75rem;
        border: 1px solid #e2e8f0;
        background: #fff
    }</style>
</head>
<body class="bg-slate-50 text-slate-900">
<header class="bg-white border-b border-slate-200">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
        <a href="{% url 'vault:snippet_list' %}" class="font-semibold">QueryVault</a>
        <nav class="flex items-center gap-3">
<!--            <a href="{% url 'vault:snippet_create' %}"-->
<!--               class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Classic Create</a>-->
            <a href="{% url 'vault:quick_save' %}"
               class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Quick Save</a>
            <a href="{% url 'vault:generate_sql' %}"
               class="px-3 py-1.5 rounded-lg border border-slate-300 bg-blue-600 text-white hover:bg-blue-700">Generate</a>
            <a href="/admin/"
               class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">Admin</a>
        </nav>
    </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid md:grid-cols-2 gap-6">
        <div class="space-y-4">
            <div>
                <label class="block text-sm text-slate-700 mb-1">Харахыг хүссэн датагаа бичнэ үү (natural
                    language)</label>
                <textarea id="ask" rows="4" placeholder="Ж: last month sales by store, top 10 ..."
                          class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-600/20"></textarea>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm text-slate-700 mb-1">DB Type</label>
                    <select id="db_type"
                            class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-600/20">
                        <option value="postgres">PostgreSQL</option>
                        <option value="mysql" selected>MySQL/MariaDB</option>
                        <option value="sqlite">SQLite</option>
                        <option value="mssql">SQL Server</option>
                        <option value="clickhouse">ClickHouse</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm text-slate-700 mb-1">Schema (сонголттой)</label>
                    <input id="schema" type="text" placeholder="Ж: sales(id, store_id, amount, date)"
                           class="w-full px-3 py-2 rounded-xl bg-white border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-600/20">
                </div>
            </div>

            <div class="flex items-center gap-3">
                <button id="genBtn" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Generate SQL
                </button>
                <span id="status" class="text-sm text-slate-500">Ready</span>
            </div>

            <div id="suggestions" class="hidden">
                <div class="text-sm text-slate-600 mb-1">Таны сангаас олдсон ижил төстэй query-үүд:</div>
                <ul id="suggList" class="space-y-1"></ul>
            </div>
        </div>

        <div class="space-y-2">
            <label class="block text-sm text-slate-700">Үр дүн (SQL)</label>
            <div id="editor" class="rounded-xl overflow-hidden bg-white"></div>
            <div class="flex items-center gap-2">
                <button id="copyBtn" class="px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50">
                    Copy
                </button>
                <button id="saveBtn"
                        class="px-3 py-1.5 rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700">
                    Save as Snippet
                </button>
            </div>
        </div>
    </div>
</main>

<script>
    // -------- CSRF
    function getCookie(name) {
        let c = null;
        if (document.cookie && document.cookie !== '') {
            document.cookie.split(';').forEach(s => {
                const t = s.trim();
                if (t.substring(0, name.length + 1) === (name + '=')) c = decodeURIComponent(t.substring(name.length + 1));
            });
        }
        return c;
    }

    const csrftoken = getCookie('csrftoken');

    // -------- Editor
    const cm = CodeMirror(document.getElementById('editor'), {
        mode: 'text/x-sql',
        theme: 'eclipse',
        lineNumbers: true,
        tabSize: 2,
        indentWithTabs: false,
        viewportMargin: Infinity,
    });

    const $ = id => document.getElementById(id);

    // -------- Suggestions renderer
    function renderSuggestions(items) {
        const box = $('suggestions'), list = $('suggList');
        list.innerHTML = '';
        if (items && items.length) {
            box.classList.remove('hidden');
            items.forEach(s => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-white border border-slate-200 rounded-lg px-3 py-2';
                li.innerHTML = `<div>
            <a href="/s/${s.id}/" class="text-blue-700 underline">${s.title}</a>
            ${s.tags ? `<span class="text-xs ml-2 bg-slate-100 rounded px-2 py-0.5">${s.tags}</span>` : ''}
            ${s.db_type ? `<span class="text-xs text-slate-500 ml-2">${s.db_type}</span>` : ''}
          </div>
          <div class="text-xs text-slate-500">Used: ${s.use_count || 0}</div>`;
                list.appendChild(li);
            });
        } else {
            box.classList.add('hidden');
        }
    }

    // -------- Generate on button only (no auto)
    let inflight = null; // AbortController
    async function generateSQLOnce() {
        const btn = $('genBtn'), status = $('status');
        const ask = $('ask').value.trim();
        const dbType = $('db_type').value;
        const schema = $('schema').value.trim();

        if (!ask) {
            status.textContent = 'Please type your request.';
            return;
        }

        // cancel any previous request if button is pressed again
        if (inflight) inflight.abort();
        inflight = new AbortController();

        // lock UI
        btn.disabled = true;
        btn.classList.add('opacity-60', 'cursor-not-allowed');
        status.textContent = 'Generating...';

        try {
            const r = await fetch('/api/snippets/ai_generate_sql/', {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
                body: JSON.stringify({ask, db_type: dbType, schema}),
                signal: inflight.signal
            });
            const data = await r.json();
            if (!r.ok || !data.ok) throw new Error((data && data.error) || 'Error');
            // FINAL — set once; no auto refresh anywhere else
            cm.setValue(data.sql || '');
            renderSuggestions(data.suggestions || []);
            status.textContent = 'Done';
        } catch (e) {
            if (e.name !== 'AbortError') status.textContent = e.message || 'Failed';
        } finally {
            // unlock UI; result remains unchanged until user clicks button again
            btn.disabled = false;
            btn.classList.remove('opacity-60', 'cursor-not-allowed');
            inflight = null;
        }
    }

    $('genBtn').addEventListener('click', generateSQLOnce);

    // copy / save
    $('copyBtn').addEventListener('click', async () => {
        await navigator.clipboard.writeText(cm.getValue());
        const b = $('copyBtn');
        b.textContent = 'Copied!';
        setTimeout(() => b.textContent = 'Copy', 1000);
    });

    $('saveBtn').addEventListener('click', async () => {
        const title = $('ask').value.slice(0, 80) || 'Generated SQL';
        const dbType = $('db_type').value;
        const payload = {
            title,
            description: 'Generated from /generate',
            db_type: dbType,
            tags: 'generated',
            sql_text: cm.getValue()
        };
        const r = await fetch('/api/snippets/', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrftoken},
            body: JSON.stringify(payload)
        });
        if (!r.ok) {
            alert('Save failed');
            return;
        }
        const d = await r.json();
        window.location.href = `/s/${d.id}/`;
    });
</script>
</body>
</html>
