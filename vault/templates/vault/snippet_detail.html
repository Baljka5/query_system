{% extends "vault/base.html" %}
{% block title %}{{ obj.title }} — QueryVault{% endblock %}
{% block content %}

<style>
    /* SQL блок дотроос сонгож хуулж болохгүй (зөвхөн товчоор хуулна) */
    #sqlBlock, #sqlBlock * {
        user-select: none;
        -webkit-user-select: none;
    }
</style>

<article class="card">
    <header class="card-header flex items-center justify-between">
        <div>
            <h2 class="text-xl font-semibold">{{ obj.title }}</h2>
            <div class="mt-1 flex items-center gap-3 text-sm text-slate-500">
                <span>{{ obj.get_db_type_display }}</span>
                {% if obj.tags %}
                <span class="flex items-center gap-1">
            {% for t in obj.tag_list %}<span class="chip">{{ t }}</span>{% endfor %}
          </span>
                {% endif %}
                <span>Updated: {{ obj.updated_at|date:"Y-m-d H:i" }}</span>
                <span>By: {{ obj.created_by|default:"—" }}</span>
                <span>Used: <strong id="useCount">{{ obj.use_count }}</strong></span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <!-- Button-look anchors (Tailwind классуудыг шууд тавив; @apply хэрэггүй) -->
            <a href="{% url 'vault:snippet_update' pk=obj.id %}"
               class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-slate-300 bg-white hover:bg-slate-50 text-slate-700">
                Edit
            </a>
            {% if request.user.is_superuser %}
            <form method="post" action="{% url 'vault:snippet_delete' pk=obj.id %}" class="inline">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-danger"
                        onclick="return confirm('Үнэхээр устгах уу?');">
                    Delete
                </button>
            </form>
            {% endif %}
            <!-- Mark Used-ийг авч хаясан -->
            <button id="copyBtn" type="button"
                    class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border border-transparent bg-blue-600 text-white hover:bg-blue-700">
                Copy SQL
            </button>
        </div>
    </header>

    <div class="card-body">
        {% if obj.description %}<p class="mb-3 text-slate-700">{{ obj.description }}</p>{% endif %}
        <pre id="sqlBlock" tabindex="0"
             class="overflow-auto bg-slate-50 border border-slate-200 rounded-xl p-4 text-sm"><code>{{ obj.sql_text }}</code></pre>
        <p id="copyHint" class="mt-2 text-xs text-slate-500">Copy хийхдээ “Copy SQL” товчийг ашиглана уу.</p>
    </div>
</article>

<script>
    // --- CSRF cookie helper ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    const csrftoken = getCookie('csrftoken');
    const SNIPPET_ID = {{ obj.id }};

    async function logCopyAndUpdateCount() {
        try {
            const r = await fetch(`/s/${SNIPPET_ID}/copy/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });
            if (!r.ok) return;

            const data = await r.json();
            if (data.ok && typeof data.use_count === 'number') {
                const uc = document.getElementById('useCount');
                if (uc) uc.textContent = data.use_count;
            }
        } catch (e) {
            console.error('copy log error', e);
        }
    }

    async function copyText(txt) {
        if (navigator.clipboard && window.isSecureContext) {
            try {
                await navigator.clipboard.writeText(txt);
                return true;
            } catch (e) {
                console.warn('navigator.clipboard failed, fallback руу орно', e);
            }
        }

        try {
            const ta = document.createElement('textarea');
            ta.value = txt;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            ta.style.top = '0';
            document.body.appendChild(ta);
            ta.focus();
            ta.select();
            const ok = document.execCommand('copy');
            document.body.removeChild(ta);
            return ok;
        } catch (e) {
            console.error('fallback copy failed', e);
            return false;
        }
    }

    const copyBtn = document.getElementById('copyBtn');
    if (copyBtn) {
        copyBtn.addEventListener('click', async () => {
            const sqlBlock = document.getElementById('sqlBlock');
            if (!sqlBlock) return;

            const txt = sqlBlock.innerText;
            const ok = await copyText(txt);

            if (ok) {
                await logCopyAndUpdateCount();
                copyBtn.textContent = 'Copied!';
                setTimeout(() => {
                    copyBtn.textContent = 'Copy SQL';
                }, 1200);
            } else {
                alert('Copy-г browser блоклож байна. Хуучин browser эсвэл security extension байж магадгүй.');
            }
        });
    }

    const sqlBlock = document.getElementById('sqlBlock');

    function nudgeHint() {
        const b = document.getElementById('copyBtn');
        const hint = document.getElementById('copyHint');
        if (b) {
            b.textContent = 'Use “Copy SQL”';
            setTimeout(() => (b.textContent = 'Copy SQL'), 1200);
        }
        if (hint) {
            hint.classList.add('text-blue-600');
            setTimeout(() => hint.classList.remove('text-blue-600'), 900);
        }
    }

    document.addEventListener('copy', (e) => {
        if (!sqlBlock) return;

        const sel = window.getSelection ? window.getSelection() : null;
        if (!sel || sel.isCollapsed) return;

        const wrap = (n) => (n ? (n.nodeType === 1 ? n : n.parentElement) : null);
        const anchorEl = wrap(sel.anchorNode);
        const focusEl = wrap(sel.focusNode);

        const inSql =
            (anchorEl && sqlBlock.contains(anchorEl)) ||
            (focusEl && sqlBlock.contains(focusEl));

        if (!inSql) return;

        e.preventDefault();
        nudgeHint();
    });

    if (sqlBlock) {
        sqlBlock.addEventListener('keydown', (ev) => {
            const isMac = /Mac|iPhone|iPad/.test(navigator.platform);
            const isCopyCombo =
                (isMac ? ev.metaKey : ev.ctrlKey) &&
                (ev.key === 'c' || ev.key === 'C');

            if (isCopyCombo) {
                ev.preventDefault();
                nudgeHint();
            }
        });
    }
</script>

{% endblock %}
